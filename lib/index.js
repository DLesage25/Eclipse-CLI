"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var e=require("dotenv"),t=require("inversify"),r=require("tslib"),n=require("fs"),i=require("minimist"),o=require("commander"),s=require("crypto"),a=require("http"),c=require("url"),u=require("open"),l=require("axios"),h=require("figlet"),p=require("keytar"),_=require("child_process"),d=require("inquirer");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function f(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var v=g(e),y=g(i),m=g(o),w=f(s),b=g(a),C=g(c),E=g(u),j=g(l),S=g(h),I=g(p),A=g(d),P=function(){function e(e){this.FILE_PATH=e}return e.prototype.find=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.promises.stat(this.FILE_PATH)];case 1:return e.sent()?[2,!0]:[2,!1];case 2:return e.sent(),[2,!1];case 3:return[2]}}))}))},e.prototype.writeFile=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){try{return[2,n.promises.writeFile(this.FILE_PATH,e).then((function(){return!0}))]}catch(e){return console.error(e),[2,!1]}return[2]}))}))},e.prototype.createOrUpdate=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.find()];case 1:return r.sent()?[2,this.replaceOnFile(e)]:(t=T(e),[2,this.writeFile(t)])}}))}))},e.prototype.read=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){try{return[2,n.promises.readFile(this.FILE_PATH).then((function(e){return e.toString()}))]}catch(e){return console.error(e),[2,""]}return[2]}))}))},e.prototype.readIntoObject=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.read()];case 1:return e=r.sent(),[2,L(e)];case 2:return t=r.sent(),console.error("Error reading file into object "+t),[2,{}];case 3:return[2]}}))}))},e.prototype.replaceOnFile=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o,s;return r.__generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.read()];case 1:return t=a.sent(),n=L(t),i=r.__assign(r.__assign({},n),e),o=T(i),[2,this.writeFile(o)];case 2:return s=a.sent(),console.error(s),[2,!1];case 3:return[2]}}))}))},e=r.__decorate([t.injectable(),r.__metadata("design:paramtypes",[String])],e)}(),L=function(e){return e.split("\n").filter((function(e){return""!==e})).reduce((function(e,t){var n,i=t.split("=");return r.__assign(r.__assign({},e),((n={})[i[0]]=i[1],n))}),{})},T=function(e){var t=r.__assign({},e),n="";for(var i in t)n+=i+"="+t[i]+"\n";return n},k="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};"function"==typeof k.setTimeout&&setTimeout,"function"==typeof k.clearTimeout&&clearTimeout;function U(e,t){this.fun=e,this.array=t}U.prototype.run=function(){this.fun.apply(null,this.array)};var R=k.performance||{};R.now||R.mozNow||R.msNow||R.oNow||R.webkitNow;new Date;var O={};const{FORCE_COLOR:H,NODE_DISABLE_COLORS:D,TERM:F}=O,N={enabled:!D&&"dumb"!==F&&"0"!==H,reset:q(0,0),bold:q(1,22),dim:q(2,22),italic:q(3,23),underline:q(4,24),inverse:q(7,27),hidden:q(8,28),strikethrough:q(9,29),black:q(30,39),red:q(31,39),green:q(32,39),yellow:q(33,39),blue:q(34,39),magenta:q(35,39),cyan:q(36,39),white:q(37,39),gray:q(90,39),grey:q(90,39),bgBlack:q(40,49),bgRed:q(41,49),bgGreen:q(42,49),bgYellow:q(43,49),bgBlue:q(44,49),bgMagenta:q(45,49),bgCyan:q(46,49),bgWhite:q(47,49)};function x(e,t){let r,n=0,i="",o="";for(;n<e.length;n++)r=e[n],i+=r.open,o+=r.close,t.includes(r.close)&&(t=t.replace(r.rgx,r.close+r.open));return i+t+o}function q(e,t){let r={open:`[${e}m`,close:`[${t}m`,rgx:new RegExp(`\\x1b\\[${t}m`,"g")};return function(t){return void 0!==this&&void 0!==this.has?(this.has.includes(e)||(this.has.push(e),this.keys.push(r)),void 0===t?this:N.enabled?x(this.keys,t+""):t+""):void 0===t?function(e,t){let r={has:e,keys:t};return r.reset=N.reset.bind(r),r.bold=N.bold.bind(r),r.dim=N.dim.bind(r),r.italic=N.italic.bind(r),r.underline=N.underline.bind(r),r.inverse=N.inverse.bind(r),r.hidden=N.hidden.bind(r),r.strikethrough=N.strikethrough.bind(r),r.black=N.black.bind(r),r.red=N.red.bind(r),r.green=N.green.bind(r),r.yellow=N.yellow.bind(r),r.blue=N.blue.bind(r),r.magenta=N.magenta.bind(r),r.cyan=N.cyan.bind(r),r.white=N.white.bind(r),r.gray=N.gray.bind(r),r.grey=N.grey.bind(r),r.bgBlack=N.bgBlack.bind(r),r.bgRed=N.bgRed.bind(r),r.bgGreen=N.bgGreen.bind(r),r.bgYellow=N.bgYellow.bind(r),r.bgBlue=N.bgBlue.bind(r),r.bgMagenta=N.bgMagenta.bind(r),r.bgCyan=N.bgCyan.bind(r),r.bgWhite=N.bgWhite.bind(r),r}([e],[r]):N.enabled?x([r],t+""):t+""}}var z=N,V=function(){function e(){}return e.prototype.showOptions=function(){return m.default.version("0.2.9").description(z.cyan("Inject environment variables on runtime")).option("--inject=all","Inject all project secrets into the execution context (make sure you are inside a project folder with an .eclipserc on it).").option("--init","Initialize the CLI and populate all required variables to communicate with Eclipse web.").outputHelp()},e=r.__decorate([t.injectable()],e)}();z.enabled=require("color-support").level;var M=function(){function e(){}return e.prototype.verticalSeparator=function(){console.log("\n =+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+ \n")},e.prototype.message=function(e){console.log(z.dim(e))},e.prototype.success=function(e){console.log(z.green(e))},e.prototype.warning=function(e){console.warn(z.yellow(e))},e.prototype.error=function(e){console.error(z.red(e))},e.prototype.banner=function(e,t){console.log(z.yellow(S.default.textSync(e,t)))},e=r.__decorate([t.injectable()],e)}(),K=function(){function e(){}return e.prototype.getKey=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,I.default.getPassword(e,t)]}))}))},e.prototype.setKey=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,I.default.setPassword(e,t,n)]}))}))},e.prototype.deleteKey=function(e,t){return I.default.deletePassword(e,t)},e=r.__decorate([t.injectable()],e)}(),B=function(){function e(e){this.keychain=e}return e.prototype.get=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.keychain.getKey("eclipse","core")];case 1:return(e=t.sent())?[2,L(e)]:[2,null]}}))}))},e.prototype.set=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){return t=T(e),[2,this.keychain.setKey("eclipse","core",t)]}))}))},e.prototype.delete=function(){return this.keychain.deleteKey("eclipse","core")},e.prototype.initialize=function(e){var t=e.ECLIPSE_AUTH_TARGET_AUDIENCE,n=e.ECLIPSE_AUTH_CLIENT_ID,i=e.ECLIPSE_AUTH_DOMAIN;return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this.set({ECLIPSE_AUTH_SERVER_PORT:4242,ECLIPSE_AUTH_CALLBACK_URL:"http://localhost:4242",ECLIPSE_AUTH_CLIENT_ID:n,ECLIPSE_AUTH_DOMAIN:i,ECLIPSE_AUTH_TARGET_AUDIENCE:t})];case 1:return e.sent(),[2,!0]}}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("KeyChain")),r.__metadata("design:paramtypes",[K])],e)}(),G=function(e,t,r){return j.default({method:"POST",url:r.ECLIPSE_AUTH_DOMAIN+"/oauth/token",headers:{"content-type":"application/x-www-form-urlencoded"},data:new URLSearchParams({grant_type:"authorization_code",client_id:r.ECLIPSE_AUTH_CLIENT_ID,code_verifier:e,code:t,redirect_uri:r.ECLIPSE_AUTH_CALLBACK_URL})}).then((function(e){var t=e.data;return{access_token:t.access_token,expires_in:t.expires_in}})).catch((function(e){throw new Error("Error attempting to request user token - "+e)}))},W=function(){function e(e,t,n){var i=this;this.keyChain=e,this.logger=t,this.coreConfig=n,this.handleAuthResponse=function(e,t,n,o){return function(s,a){return r.__awaiter(i,void 0,void 0,(function(){var i,c,u,l,h,p,_,d,g,f,v;return r.__generator(this,(function(r){switch(r.label){case 0:if(!s.url)return[2];if(i=C.default.parse(s.url,!0).query,c=i.code,u=i.state,l=i.error,h=i.error_description,!c||!u)return a.write("\n            <html>\n            <body>\n                <h1>LOGIN FAILED</h1>\n                <div>"+l+"</div>\n                <div>"+h+"\n            </body>\n            </html>\n            "),[2];a.write("\n            <html>\n            <body>\n                <h1>LOGIN SUCCEEDED</h1>\n                <p>You can close this browser window and go back to your terminal.</p>\n            </body>\n            </html>\n            "),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,G(e,c,o)];case 2:return p=r.sent(),_=p.access_token,d=p.expires_in,g=(Date.now()+1e3*d).toString(),f=T({access_token:_,expiration_date:g}),t.setKey("eclipse","auth",f),[2,a.end()];case 3:return v=r.sent(),n.error("Error attempting to save access token: "+v),[3,4];case 4:return[2]}}))}))}},this.codeVerifier=this.createCodeVerifier(),this.authConfig=null}return e.prototype.checkIfAuthFlowRequired=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.keyChain.getKey("eclipse","auth")];case 1:return(e=t.sent())?(this.authConfig=L(e),[4,this.checkIfTokenExpired()]):[2,this.initializeAuthFlow()];case 2:return t.sent()?[2,this.initializeAuthFlow()]:(this.logger.success("Session restored. Welcome back!"),[2,!1])}}))}))},e.prototype.initializeAuthFlow=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,o,s,a,c;return r.__generator(this,(function(r){switch(r.label){case 0:return e=this.createCodeChallenge(this.codeVerifier),[4,this.coreConfig.get()];case 1:return(t=r.sent())?(n=t.ECLIPSE_AUTH_DOMAIN,i=t.ECLIPSE_AUTH_CLIENT_ID,o=t.ECLIPSE_AUTH_CALLBACK_URL,s=t.ECLIPSE_AUTH_SERVER_PORT,a=t.ECLIPSE_AUTH_TARGET_AUDIENCE,this.createAuthServer({ECLIPSE_AUTH_DOMAIN:n,ECLIPSE_AUTH_CLIENT_ID:i,ECLIPSE_AUTH_CALLBACK_URL:o,ECLIPSE_AUTH_SERVER_PORT:s}),c=this.constructAuthUrl(e,"abc123",{ECLIPSE_AUTH_DOMAIN:n,ECLIPSE_AUTH_CLIENT_ID:i,ECLIPSE_AUTH_TARGET_AUDIENCE:a,ECLIPSE_AUTH_CALLBACK_URL:o}),[4,this.openAuthPage(c)]):(this.logger.error("Core config missing. Please run eclipse --init"),[2,!1]);case 2:return r.sent(),this.logger.success("You are now logged in! Please hit control+C and run eclipse again in your terminal."),[2,!0]}}))}))},e.prototype.getConfig=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.keyChain.getKey("eclipse","auth")];case 1:return(e=t.sent())?[2,L(e)]:[2,null]}}))}))},e.prototype.checkIfTokenExpired=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){return(e=this.authConfig.expiration_date)&&Number(e)<=Date.now()?[2,!0]:[2,!1]}))}))},e.prototype.base64URLEncode=function(e){return e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},e.prototype.sha256=function(e){return w.createHash("sha256").update(e).digest()},e.prototype.createCodeVerifier=function(){return this.base64URLEncode(w.randomBytes(32))},e.prototype.createCodeChallenge=function(e){return this.base64URLEncode(this.sha256(e))},e.prototype.createAuthServer=function(e){var t=this;return b.default.createServer(this.handleAuthResponse(this.codeVerifier,this.keyChain,this.logger,e)).listen(e.ECLIPSE_AUTH_SERVER_PORT,(function(r){r&&t.logger.error("Unable to start an HTTP server on port "+e.ECLIPSE_AUTH_SERVER_PORT+": "+r)}))},e.prototype.constructAuthUrl=function(e,t,r){return[r.ECLIPSE_AUTH_DOMAIN+"/authorize","?response_type=code","&code_challenge_method=S256","&code_challenge="+e,"&client_id="+r.ECLIPSE_AUTH_CLIENT_ID,"&redirect_uri="+r.ECLIPSE_AUTH_CALLBACK_URL,"&scope=email","&audience="+r.ECLIPSE_AUTH_TARGET_AUDIENCE,"&state="+t].join("")},e.prototype.openAuthPage=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,E.default(e,{wait:!0,newInstance:!0})];case 1:return r.sent(),[2];case 2:return t=r.sent(),this.logger.error("Error attempting to open authentication page in browser: "+t),[2];case 3:return[2]}}))}))},e.prototype.logout=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this.keyChain.deleteKey("eclipse","auth")];case 1:return e.sent(),this.logger.message("You've been logged out successfully."),[2]}}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("KeyChain")),r.__param(1,t.inject("Logger")),r.__param(2,t.inject("CoreConfig")),r.__metadata("design:paramtypes",[K,M,B])],e)}(),J=function(){function e(e,t,r){this.auth=e,this.logger=t,this.coreConfig=r,this._http=j.default.create({baseURL:"http://localhost:8080/v1",headers:{Authorization:"","X-ECLIPSE_CLI_KEY":"thisisatest"}})}return e.prototype.Initialize=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.auth.getConfig()];case 1:return e=r.sent(),[4,this.coreConfig.get()];case 2:return t=r.sent(),e&&t?(n=e.access_token,this._http.interceptors.request.use((function(e){return e.headers||(e.headers={}),e.headers.Authorization="Bearer "+n,e})),[2]):(this.logger.error("Could not initialize API. Auth or core config not found"),[2])}}))}))},e.prototype.getCliValues=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,this._http.post("/cli").then((function(e){return e.data}))]}))}))},e.prototype.getUser=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,this._http.get("/users/").then((function(e){return e.data}))]}))}))},e.prototype.getProjects=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n=this;return r.__generator(this,(function(r){return t=e?{params:{projectId:e}}:void 0,[2,this._http.get("/projects/",t).then((function(e){return"string"==typeof e.data?JSON.parse(e.data):e.data})).catch((function(e){return n.logger.error("Error when attempting to fetch projects: "+e),[]}))]}))}))},e.prototype.getSecrets=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return[2,this._http.get("/secrets/reveal",{data:{project:{_id:e}}}).then((function(e){return e.data})).catch((function(e){return t.logger.error("Error attempting to fetch secrets: "+e),[]}))]}))}))},e.prototype.createSecret=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return[2,this._http.post("/secrets",e).then((function(e){return e.data})).catch((function(e){return t.logger.error("Error attempting to create secret: "+e),null}))]}))}))},e.prototype.deleteSecret=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return[2,this._http.delete("/secrets/"+e).then((function(e){t.logger.success("Secret "+e.data._id+" successfully deleted.")})).catch((function(e){return t.logger.error("Error attempting to delete secret: "+e),null}))]}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("Auth")),r.__param(1,t.inject("Logger")),r.__param(2,t.inject("CoreConfig")),r.__metadata("design:paramtypes",[W,M,B])],e)}(),Y=function(){function e(){}return e.prototype.initialize=function(e,t,n){var i=this.sanitizeEnv(r.__assign(r.__assign({},process.env),n));_.spawn(e,t,{stdio:"inherit",env:i})},e.prototype.sanitizeEnv=function(e){var t=r.__assign(r.__assign({},process.env),e);return Object.entries(t).reduce((function(e,t){var n=r.__read(t,2),i=n[0],o=n[1];return i.includes("ECLIPSE")||(e[i]=o),e}),{})},e=r.__decorate([t.injectable()],e)}(),$=function(){function e(e,t){this.logger=e,this.configFile=t}return e.prototype.createConfigFile=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.configFile.createOrUpdate({PROJECT:e})];case 1:return t.sent(),this.logger.success("Config file created on current directory."),[2]}}))}))},e.prototype.readConfigFile=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,this.configFile.readIntoObject()]}))}))},e.prototype.checkIfExists=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,this.configFile.find()]}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("Logger")),r.__param(1,t.inject("ConfigFile")),r.__metadata("design:paramtypes",[M,P])],e)}(),X=[{name:"Initialize a config file in this directory.",value:"createConfig",short:"Create config file"},{name:"Add a secret to this project.",value:"add",short:"Add secret"},{name:"Remove a secret from this project.",value:"remove",short:"Remove secret"},{name:"View secrets from this project.",value:"view",short:"View secrets"},{name:"Print project secrets to an .env file.",value:"print",short:"Print secrets to env file"}];function Q(e){var t=e.map((function(e){return{name:e.name+" - "+e.createdAt,value:e._id,short:e.name}}));return A.default.prompt([{type:"list",name:"projectId",message:"Please select a project.",choices:t},{type:"list",name:"action",message:"What would you like to do?",choices:X}])}var Z=[{name:"View secrets from this project.",value:"view",short:"View secrets"},{name:"Add a secret to this project.",value:"add",short:"Add secret"},{name:"Remove a secret from this project.",value:"remove",short:"Remove secret"},{name:"Print project secrets to an .env file.",value:"print",short:"Print secrets to env file"}];var ee=function(){function e(e,t){this._api=e,this.logger=t}return e.prototype.addSecret=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o,s,a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,A.default.prompt([{type:"input",name:"name",message:"Please set the name of this secret:"},{type:"password",name:"value",message:"Please set the secret value"},{type:"input",name:"rawClassifiers",message:"Classifiers let you order secrets based on categories. Please add classifiers separated by a space."}])];case 1:return t=r.sent(),n=t.name,i=t.value,o=t.rawClassifiers,s=o.split(" "),[4,this._api.createSecret({projectId:e._id,name:n,value:i,classifiers:s})];case 2:return a=r.sent().name,this.logger.success("Secret "+a+" created under project "+e.name+"."),[2]}}))}))},e.prototype.getSecrets=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(i){switch(i.label){case 0:return[4,this._api.getSecrets(e._id)];case 1:return(t=i.sent()).length?(n=t.reduce((function(e,t){var n;return r.__assign(r.__assign({},e),((n={})[t.name]=t.value,n))}),{}),[2,n]):[2]}}))}))},e.prototype.removeSecret=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,(i=e.secrets,o=i.map((function(e){return{name:e.name,value:e._id,short:e.name}})),A.default.prompt([{type:"list",name:"secretId",message:"Please select the secret you would like to remove:",choices:o},{type:"confirm",name:"confirm",message:"This action cannot be undone. Please confirm deletion:"}]))];case 1:return t=r.sent(),n=t.secretId,t.confirm||this.logger.message("Cancelled."),[2,this._api.deleteSecret(n)]}var i,o}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("API")),r.__param(1,t.inject("Logger")),r.__metadata("design:paramtypes",[J,M])],e)}(),te=function(){function e(e,t,r,n,i,o){this._api=e,this.logger=t,this.secrets=r,this.envFile=n,this.projectConfig=i,this.cmd=o}return e.prototype.projectActions=function(e,t){switch(e){case"view":return this.viewProjectSecrets(t);case"add":return this.secrets.addSecret(t);case"remove":return this.secrets.removeSecret(t);case"print":return this.printSecrets(t);case"createConfig":return this.projectConfig.createConfigFile(t._id);default:return void this.logger.warning("Command not recognized")}},e.prototype.projectSelection=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._api.getProjects()];case 1:return(e=r.sent()).length?[4,Q(e)]:(this.logger.warning("No projects found. Try creating one first."),[2]);case 2:return t=r.sent(),n=t.projectId,i=t.action,(o=e.find((function(e){return e._id===n})))?[2,this.projectActions(i,o)]:(this.logger.warning("No project selected."),[2])}}))}))},e.prototype.getProject=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this._api.getProjects(e)];case 1:return t=r.__read.apply(void 0,[n.sent(),1]),[2,t[0]]}}))}))},e.prototype.promptSingleProjectActions=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.getProject(e)];case 1:return(t=r.sent())?[4,(i=t.name,A.default.prompt([{type:"list",name:"action",message:"Looks like you are in the project "+i+" directory. What would you like to do?",choices:Z}]))]:(this.logger.error("It looks like you do not have access to the project tagged in this directory."),[2]);case 2:return n=r.sent().action,[2,this.projectActions(n,t)]}var i}))}))},e.prototype.viewProjectSecrets=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.secrets.getSecrets(e)];case 1:return(t=r.sent())?(n=T(t),this.logger.success(n),[2]):(this.logger.warning("No secrets found for project "+e.name),[2])}}))}))},e.prototype.printSecrets=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.secrets.getSecrets(e)];case 1:return(t=r.sent())?[4,this.envFile.createOrUpdate(t)]:(this.logger.warning("No secrets found for project "+e.name),[2]);case 2:return r.sent(),this.logger.success("Environment file printed on working directory."),[2]}}))}))},e.prototype.projectDirectoryMenu=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.projectConfig.checkIfExists()];case 1:return t.sent()?[4,this.projectConfig.readConfigFile()]:[2,!1];case 2:return(e=t.sent()).PROJECT?[4,this.promptSingleProjectActions(e.PROJECT)]:(this.logger.error("Malformed config file. Try re-creating the .eclipserc file in your project directory."),[2,!0]);case 3:return t.sent(),[2,!0]}}))}))},e.prototype.checkIfOnProjectDirectory=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,this.projectConfig.checkIfExists()]}))}))},e.prototype.getCurrentProjectSecrets=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.projectConfig.readConfigFile()];case 1:return(e=r.sent()).PROJECT?[4,this.getProject(e.PROJECT)]:(this.logger.error("Malformed config file. Try re-creating the .eclipserc file in your project directory."),[2]);case 2:return t=r.sent(),[4,this.secrets.getSecrets(t)];case 3:return(n=r.sent())?[2,n]:(this.logger.warning("No secrets found for project "+t.name),[2])}}))}))},e.prototype.injectLocalProjectSecrets=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return console.log(e,t),[4,this.getCurrentProjectSecrets()];case 1:return(n=r.sent())?[2,this.cmd.initialize(e,t,n)]:[2]}}))}))},e=r.__decorate([t.injectable(),r.__param(0,t.inject("API")),r.__param(1,t.inject("Logger")),r.__param(2,t.inject("Secrets")),r.__param(3,t.inject("EnvFile")),r.__param(4,t.inject("ProjectConfig")),r.__param(5,t.inject("CMD")),r.__metadata("design:paramtypes",[J,M,ee,P,$,Y])],e)}(),re=[{name:"See my projects",value:"view",short:"View projects"},{name:"Log out",value:"logout",short:"Log out"}];var ne=function(){function e(e,t,r,n,i,o){var s=this;this.options=e,this.auth=t,this.logger=r,this._api=n,this.projects=i,this.coreConfig=o,this.suppressError=!1;try{this.execute().then((function(e){s.logger.verticalSeparator(),e||s.suppressError||process.exit(1)})).catch((function(e){return r.error(e)}))}catch(e){e instanceof Error?r.error(e.message):r.error(""+e),this.suppressError||process.exit(1)}}return e.prototype.execute=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return console.clear(),this.showIntroLog(),e=y.default(process.argv.slice(2)),this.suppressError=e.suppressError,e.v||e.version?(this.showToolVersion(),[2,!0]):e.h||e.help?(this.showHelpLog(),[2,!0]):[4,this.checkForCoreConfig()];case 1:return r.sent()?(t=e.init,n=e._,console.log(e),t?[2,this.restartCoreConfig()]:[4,this.auth.checkIfAuthFlowRequired()]):[2,!0];case 2:return r.sent()?[2,!0]:[4,this._api.Initialize()];case 3:return r.sent(),this.logger.verticalSeparator(),[4,this.projects.checkIfOnProjectDirectory()];case 4:return(i=r.sent())&&n.length?[4,this.projectDirectoryActions(n)]:[3,6];case 5:return r.sent(),[2,!0];case 6:return i?[4,this.projects.projectDirectoryMenu()]:[3,8];case 7:r.sent(),r.label=8;case 8:return i?[3,10]:[4,this.showTopLevelMenu()];case 9:r.sent(),r.label=10;case 10:return[2,!0]}}))}))},e.prototype.checkForCoreConfig=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.coreConfig.get()];case 1:return t.sent()?[2,!0]:(this.logger.warning("The CLI is syncing with Eclipse servers..."),[4,this._api.getCliValues()]);case 2:return(e=t.sent())?e?[4,this.coreConfig.initialize(e)]:(this.logger.error("We were not able to contact the Eclipse servers. Please retry, or if the problem persists contact support @ support@eclipsejs.io"),[2,!1]):[2,!1];case 3:return t.sent(),this.logger.success("Eclipse has been configured successfully. Please run Eclipse again to log in. :)"),[2,!1]}}))}))},e.prototype.processInjectCommand=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i;return r.__generator(this,(function(o){switch(o.label){case 0:return(t=r.__read(e))[0],n=t[1],i=t.slice(2),[4,this.projects.injectLocalProjectSecrets(n,i)];case 1:return o.sent(),[2,!0]}}))}))},e.prototype.projectDirectoryActions=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o=this;return r.__generator(this,(function(s){return t=r.__read(e),n=t[0],i=t.slice(1),"inject"===n?[2,this.processInjectCommand(i)]:[2,function(){return o.logger.warning("Command not recognized")}]}))}))},e.prototype.restartCoreConfig=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this.coreConfig.delete()];case 1:return e.sent(),[4,this.checkForCoreConfig()];case 2:return e.sent(),this.logger.success("Eclipse has been configured successfully. Please run Eclipse again and log in. :)"),[2,!0]}}))}))},e.prototype.showTopLevelMenu=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,A.default.prompt([{type:"list",name:"action",message:"What would you like to do?",choices:re}])];case 1:return"view"!==(e=t.sent().action)?[3,3]:[4,this.projects.projectSelection()];case 2:t.sent(),t.label=3;case 3:return"logout"!==e?[3,5]:[4,this.auth.logout()];case 4:t.sent(),t.label=5;case 5:return[2,!0]}}))}))},e.prototype.showIntroLog=function(){this.logger.banner("EclipseJS",{horizontalLayout:"full"}),this.logger.message("Inject environment variables on runtime.")},e.prototype.showToolVersion=function(){this.logger.message("Version: 0.2.9")},e.prototype.showHelpLog=function(){this.options.showOptions()},e=r.__decorate([t.injectable(),r.__param(0,t.inject("Options")),r.__param(1,t.inject("Auth")),r.__param(2,t.inject("Logger")),r.__param(3,t.inject("API")),r.__param(4,t.inject("Projects")),r.__param(5,t.inject("CoreConfig")),r.__metadata("design:paramtypes",[V,W,M,J,te,B])],e)}();function ie(){var e=new t.Container;return e.bind("Eclipse").to(ne).inSingletonScope(),e.bind("Options").to(V).inSingletonScope(),e.bind("Auth").to(W).inRequestScope(),e.bind("Logger").to(M).inSingletonScope(),e.bind("API").to(J).inSingletonScope(),e.bind("Projects").to(te).inSingletonScope(),e.bind("Secrets").to(ee).inSingletonScope(),e.bind("KeyChain").to(K).inSingletonScope(),e.bind("CMD").to(Y).inSingletonScope(),e.bind("CoreConfig").to(B).inSingletonScope(),e.bind("ProjectConfig").to($).inSingletonScope(),e.bind("EnvFile").toDynamicValue((function(){return new P("./.env")})),e.bind("ConfigFile").toDynamicValue((function(){return new P("./.eclipserc")})),e.get("Eclipse")}v.default.config(),ie(),exports.index=ie;
